# Logic Lab Game - Technical Specification

**Version:** 1.0
**Last Updated:** 2025-11-01
**Status:** Design Phase

---

## 1. Overview

### 1.1 Game Concept
**Logic Lab** (Logik-Labor) is an LLM-powered cognitive training game for children aged 5-8. Unlike the existing games (Verbal Memory, Visual Memory, Reaction Time), this game generates dynamic, adaptive problems using AI.

### 1.2 Core Features
- **LLM-Generated Problems:** Each problem is unique, generated by OpenRouter API
- **Initial Difficulty Input:** Adults provide context (e.g., "7-year-old, loves animals, struggles with math")
- **Multiple Choice Interface:** Kids choose from 4 button options (no typing)
- **Adaptive Difficulty:** Problems get easier/harder based on performance
- **Problem Variety:** Mix of riddles, patterns, categorization, cause-effect
- **Safety First:** Strict content filtering, no personal information collection

### 1.3 User Flow
```
1. Adult enters initial difficulty guidance (text input)
2. System generates first problem based on guidance
3. Kid sees problem + 4 button choices
4. Kid clicks an answer
5. System shows feedback (correct/incorrect + explanation) for 3 seconds
6. System generates next problem (adapted based on performance)
7. Repeat for 5 problems total
8. Show final score and stats
```

---

## 2. Technical Architecture

### 2.1 Layer Breakdown

```
┌─────────────────────────────────────────────────────┐
│  UI Layer (Svelte 5)                                │
│  /routes/game/logic-lab/+page.svelte                │
│  - Initial difficulty input form                    │
│  - Problem display + 4 choice buttons               │
│  - Feedback display                                 │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│  API Layer (SvelteKit Routes)                       │
│  /routes/api/game/logic-lab/                        │
│  - POST /start     → Initialize game                │
│  - POST /answer    → Submit answer, get next        │
│  - GET  /stats     → Get statistics                 │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│  Service Layer                                       │
│  - LogicLabEngine  → Game logic, scoring            │
│  - LLMService      → OpenRouter API integration     │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│  Repository Layer                                    │
│  - GameSessionRepository → MongoDB CRUD             │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│  Database Layer                                      │
│  - MongoDB → GameSession collection                 │
└─────────────────────────────────────────────────────┘
```

### 2.2 Data Flow

**Starting a Game:**
```typescript
User → UI (submit initial guidance)
  → POST /api/game/logic-lab/start { userId, difficulty, initialGuidance }
    → LogicLabEngine.startGame()
      → LLMService.generateProblem(guidance)
        → OpenRouter API call
      → GameSessionRepository.create()
        → MongoDB insert
      → Return { sessionId, problem, options, score, lives, round }
  → UI displays problem + 4 buttons
```

**Submitting an Answer:**
```typescript
User → UI (click answer button)
  → POST /api/game/logic-lab/answer { sessionId, answerIndex }
    → LogicLabEngine.submitAnswer()
      → GameSessionRepository.findById()
        → MongoDB query
      → Evaluate answer (correct/incorrect)
      → Update score/lives
      → Determine next difficulty level
      → LLMService.generateProblem(adaptedDifficulty)
        → OpenRouter API call
      → GameSessionRepository.update()
        → MongoDB update
      → Return { correct, explanation, nextProblem, nextOptions, score, lives, round, gameOver }
  → UI shows feedback for 3 seconds
  → UI displays next problem or game over screen
```

---

## 3. Database Schema

### 3.1 GameSession Updates

Add to existing `GameSession` interface:

```typescript
export interface GameSession {
  // ... existing fields (userId, gameType, difficulty, score, lives, etc.)
  logicLabState?: LogicLabGameState;
}

export interface LogicLabGameState {
  // Initial configuration
  initialGuidance: string;           // Adult's input (e.g., "7yo, loves animals")
  modelName: string;                 // OpenRouter model used

  // Current problem
  currentProblem: Problem;

  // Performance tracking
  problemHistory: Problem[];         // All problems shown
  correctAnswers: number;            // Total correct
  consecutiveCorrect: number;        // Streak for difficulty adjustment
  consecutiveIncorrect: number;      // Streak for difficulty adjustment

  // Difficulty progression
  currentDifficultyLevel: number;    // 1-5 scale (1=easiest, 5=hardest)

  // Game config
  totalProblems: number;             // Always 5
  hintsUsed: number;                 // Future feature
}

export interface Problem {
  id: string;                        // Unique ID
  type: ProblemType;                 // 'riddle' | 'pattern' | 'category' | 'cause-effect'
  question: string;                  // The problem text
  options: string[];                 // 4 answer choices
  correctIndex: number;              // 0-3
  explanation: string;               // Why the answer is correct
  difficultyLevel: number;           // 1-5
  timestamp: Date;                   // When shown
  userAnswerIndex?: number;          // What kid chose (0-3)
  isCorrect?: boolean;               // Result
  responseTime?: number;             // ms to answer
}

export type ProblemType = 'riddle' | 'pattern' | 'category' | 'cause-effect';
```

### 3.2 MongoDB Storage

No schema migration needed - MongoDB will automatically store the new `logicLabState` field.

**Example Document:**
```json
{
  "_id": "...",
  "userId": "user123",
  "gameType": "logic-lab",
  "difficulty": "easy",
  "score": 3,
  "lives": 2,
  "round": 4,
  "isActive": true,
  "startedAt": "2025-11-01T10:00:00Z",
  "logicLabState": {
    "initialGuidance": "7 Jahre alt, mag Tiere, Mathe ist schwierig",
    "modelName": "anthropic/claude-3.5-haiku",
    "currentProblem": {
      "id": "prob-004",
      "type": "riddle",
      "question": "Welches Tier hat einen langen Rüssel?",
      "options": ["Hund", "Elefant", "Katze", "Vogel"],
      "correctIndex": 1,
      "explanation": "Der Elefant hat einen langen Rüssel.",
      "difficultyLevel": 2,
      "timestamp": "2025-11-01T10:03:00Z"
    },
    "problemHistory": [...],
    "correctAnswers": 3,
    "consecutiveCorrect": 2,
    "consecutiveIncorrect": 0,
    "currentDifficultyLevel": 2,
    "totalProblems": 5,
    "hintsUsed": 0
  }
}
```

---

## 4. LLM Integration (OpenRouter)

### 4.1 Service Architecture

**File:** `src/lib/services/llm.service.ts`

```typescript
export class LLMService {
  private apiKey: string;
  private baseUrl: string = 'https://openrouter.ai/api/v1';
  private defaultModel: string = 'anthropic/claude-3.5-haiku';

  constructor(apiKey?: string) {
    this.apiKey = apiKey || env.OPENROUTER_API_KEY;
    if (!this.apiKey) {
      throw new Error('OPENROUTER_API_KEY is required');
    }
  }

  async generateProblem(params: GenerateProblemParams): Promise<Problem>;
  private buildSystemPrompt(params: GenerateProblemParams): string;
  private buildUserPrompt(params: GenerateProblemParams): string;
  private parseResponse(response: string): Problem;
  private validateProblem(problem: Problem): boolean;
}
```

### 4.2 OpenRouter API Integration

**Endpoint:** `https://openrouter.ai/api/v1/chat/completions`

**Headers:**
```typescript
{
  'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
  'Content-Type': 'application/json',
  'HTTP-Referer': 'https://localhost:5173',  // For ranking
  'X-Title': 'Kinder Denkspiele'             // For ranking
}
```

**Request Body:**
```typescript
{
  model: 'anthropic/claude-3.5-haiku',  // Fast + cheap + high quality
  messages: [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ],
  temperature: 0.9,           // High creativity for varied problems
  max_tokens: 400,            // Enough for problem + options + explanation
  response_format: {
    type: 'json_object'       // Structured output
  }
}
```

**Response:**
```typescript
{
  choices: [{
    message: {
      role: 'assistant',
      content: '{"type":"riddle","question":"...","options":[...],"correctIndex":1,"explanation":"..."}'
    }
  }],
  usage: {
    prompt_tokens: 150,
    completion_tokens: 80,
    total_tokens: 230
  }
}
```

### 4.3 Prompt Management with YAML + Jinja2

**File Structure:**
```
src/lib/prompts/
├── generate-problem.yaml       # Main problem generation prompt
└── README.md                   # Prompt documentation
```

**Prompt File:** `src/lib/prompts/generate-problem.yaml`

```yaml
# Problem Generation Prompt for Logic Lab Game
version: "1.0.0"
model: "anthropic/claude-3.5-haiku"
temperature: 0.9
max_tokens: 400
response_format:
  type: "json_object"

system_prompt: |
  Du bist ein freundlicher Lehrer für Kinder.

  ZIELGRUPPE:
  {% if initial_guidance %}
  {{ initial_guidance }}
  {% else %}
  Kinder im Alter von {{ age }} Jahren (Schwierigkeit: {{ difficulty }})
  {% endif %}

  AUFGABE:
  Erstelle ein {{ problem_type }} auf Deutsch mit Schwierigkeitsgrad {{ difficulty_level }}/5.

  STRIKTE SICHERHEITSREGELN:
  1. NUR kinderfreundliche Themen: Tiere, Natur, Farben, Formen, einfache Zahlen
  2. KEINE Erwähnung von: Gewalt, Tod, Religion, Politik, echte Personen/Namen
  3. Wörter müssen für {{ age }}-jährige verständlich sein
  4. KEINE persönlichen Fragen ans Kind
  5. KEINE Aufforderungen zu persönlichen Informationen

  SCHWIERIGKEITSGRADE:
  - Level 1 (sehr leicht): 1 Silbe, offensichtliche Antworten (5-6 Jahre)
  - Level 2 (leicht): 1-2 Silben, einfache Logik
  - Level 3 (mittel): 2-3 Silben, Mustererkennung
  - Level 4 (schwer): Zusammengesetzte Wörter, komplexere Logik (7-8 Jahre)
  - Level 5 (sehr schwer): Abstrakte Konzepte, Mehrschritt-Logik

  PROBLEMTYPEN:
  - riddle: "Ich bin gelb und rund und leuchte am Himmel. Was bin ich?"
  - pattern: "Was kommt als nächstes? 2, 4, 6, ___"
  - category: "Welches passt nicht? Hund, Katze, Auto, Maus"
  - cause-effect: "Was passiert, wenn Eis warm wird?"

  AUSGABEFORMAT (JSON):
  {
    "type": "riddle|pattern|category|cause-effect",
    "question": "Die Frage oder das Rätsel",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correctIndex": 0-3,
    "explanation": "Kurze kindgerechte Erklärung (1 Satz)"
  }

  WICHTIG:
  - Genau 4 Optionen
  - Nur EINE korrekte Antwort
  - Falsche Optionen sind plausibel aber eindeutig falsch
  - Erklärung ist positiv und ermutigend

user_prompt: |
  Erstelle jetzt ein neues {{ problem_type }} für Level {{ difficulty_level }}.
  {% if previous_problems|length > 0 %}
  Vermeide ähnliche Themen wie: {{ previous_problems|join(", ") }}
  {% endif %}

# Variables that can be passed to the prompt
variables:
  - name: "initial_guidance"
    type: "string"
    required: false
    description: "Optional adult-provided guidance for difficulty/focus"
  - name: "age"
    type: "number"
    required: true
    description: "Child's age (5-8)"
  - name: "difficulty"
    type: "string"
    required: true
    description: "Difficulty level: 'easy' or 'hard'"
  - name: "difficulty_level"
    type: "number"
    required: true
    description: "Numeric difficulty (1-5)"
  - name: "problem_type"
    type: "string"
    required: true
    description: "Type of problem: riddle, pattern, category, cause-effect"
  - name: "previous_problems"
    type: "array"
    required: false
    description: "List of previous problem themes to avoid repetition"
```

**Implementation in TypeScript:**

```typescript
// File: src/lib/services/prompt-loader.service.ts
import fs from 'fs';
import path from 'path';
import yaml from 'yaml';
import nunjucks from 'nunjucks';

interface PromptConfig {
  version: string;
  model: string;
  temperature: number;
  max_tokens: number;
  response_format?: { type: string };
  system_prompt: string;
  user_prompt: string;
  variables: Array<{
    name: string;
    type: string;
    required: boolean;
    description: string;
  }>;
}

export class PromptLoader {
  private promptsDir: string;
  private env: nunjucks.Environment;

  constructor() {
    this.promptsDir = path.join(process.cwd(), 'src', 'lib', 'prompts');
    this.env = nunjucks.configure({ autoescape: false });
  }

  loadPrompt(promptName: string): PromptConfig {
    const promptPath = path.join(this.promptsDir, `${promptName}.yaml`);
    const content = fs.readFileSync(promptPath, 'utf-8');
    return yaml.parse(content);
  }

  renderPrompt(promptName: string, variables: Record<string, any>): {
    model: string;
    temperature: number;
    max_tokens: number;
    response_format?: { type: string };
    system_prompt: string;
    user_prompt: string;
  } {
    const config = this.loadPrompt(promptName);

    // Validate required variables
    for (const varDef of config.variables) {
      if (varDef.required && !(varDef.name in variables)) {
        throw new Error(`Missing required variable: ${varDef.name}`);
      }
    }

    // Render prompts with Jinja2
    const systemPrompt = this.env.renderString(config.system_prompt, variables);
    const userPrompt = this.env.renderString(config.user_prompt, variables);

    return {
      model: config.model,
      temperature: config.temperature,
      max_tokens: config.max_tokens,
      response_format: config.response_format,
      system_prompt: systemPrompt,
      user_prompt: userPrompt
    };
  }
}
```

**Usage Example:**

```typescript
// In LLMService
const promptLoader = new PromptLoader();
const rendered = promptLoader.renderPrompt('generate-problem', {
  initial_guidance: 'Kind liebt Tiere, 7 Jahre alt',
  age: 7,
  difficulty: 'easy',
  difficulty_level: 2,
  problem_type: 'riddle',
  previous_problems: ['Hund', 'Katze', 'Sonne']
});

// Use rendered.system_prompt, rendered.user_prompt in API call
const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${this.apiKey}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    model: rendered.model,
    temperature: rendered.temperature,
    max_tokens: rendered.max_tokens,
    response_format: rendered.response_format,
    messages: [
      { role: 'system', content: rendered.system_prompt },
      { role: 'user', content: rendered.user_prompt }
    ]
  })
});
```

**Dependencies to Add:**

```bash
npm install yaml nunjucks
npm install --save-dev @types/nunjucks
```

### 4.4 Model Selection

**Primary Model:** `anthropic/claude-3.5-haiku`
- **Cost:** ~$0.001 per problem (very cheap)
- **Speed:** ~1-2 seconds response time
- **Quality:** Excellent for structured outputs
- **Reasoning:** Best balance of cost/speed/quality

**Fallback Models:**
1. `google/gemini-flash-1.5` - Similar cost, fast
2. `openai/gpt-4o-mini` - Slightly more expensive but reliable

**Cost Estimate:**
- 1 game = 5 problems = ~$0.005
- 1000 games = $5
- Very affordable for hobby project

### 4.5 Content Safety

**Multiple Layers:**

1. **System Prompt:** Strict rules about appropriate content
2. **Response Validation:** Check for banned words/topics
3. **Fallback Problems:** Pre-written safe problems if LLM fails
4. **Logging:** Store all problems for manual review

```typescript
const BANNED_WORDS = [
  'tot', 'sterben', 'gewalt', 'blut', 'waffe',
  // ... more banned words
];

function validateContent(problem: Problem): boolean {
  const text = `${problem.question} ${problem.options.join(' ')} ${problem.explanation}`;
  const lowerText = text.toLowerCase();

  for (const word of BANNED_WORDS) {
    if (lowerText.includes(word)) {
      console.error('Content safety violation:', word);
      return false;
    }
  }

  return true;
}
```

**Fallback Problems:**
```typescript
const FALLBACK_PROBLEMS: Problem[] = [
  {
    type: 'riddle',
    question: 'Welches Tier macht "Wuff"?',
    options: ['Katze', 'Hund', 'Vogel', 'Maus'],
    correctIndex: 1,
    explanation: 'Der Hund macht "Wuff"!',
    difficultyLevel: 1
  },
  // ... 10 pre-written safe problems
];
```

---

## 5. Game Logic (LogicLabEngine)

### 5.1 Service Architecture

**File:** `src/lib/services/logic-lab.service.ts`

```typescript
export class LogicLabEngine {
  private repository: GameSessionRepository;
  private llmService: LLMService;

  constructor() {
    this.repository = new GameSessionRepository();
    this.llmService = new LLMService();
  }

  // Public API
  async startGame(params: StartGameParams): Promise<GameSession>;
  async submitAnswer(sessionId: string, answerIndex: number): Promise<SubmitAnswerResult>;
  async getStats(sessionId: string): Promise<GameStats>;

  // Private helpers
  private async generateFirstProblem(params: GenerateProblemParams): Promise<Problem>;
  private async generateNextProblem(session: GameSession): Promise<Problem>;
  private calculateNextDifficulty(session: GameSession): number;
  private evaluateAnswer(session: GameSession, answerIndex: number): boolean;
  private updateScore(session: GameSession, isCorrect: boolean): void;
  private isGameOver(session: GameSession): boolean;
}
```

### 5.2 Scoring System

**Rules:**
- **Correct answer:** +1 point, no life lost
- **Incorrect answer:** 0 points, -1 life
- **Maximum score:** 5 (one per problem)
- **Starting lives:** 3
- **Game over:** When lives = 0 OR all 5 problems completed

**Implementation:**
```typescript
private updateScore(session: GameSession, isCorrect: boolean): void {
  if (isCorrect) {
    session.score += 1;
    session.logicLabState!.correctAnswers += 1;
    session.logicLabState!.consecutiveCorrect += 1;
    session.logicLabState!.consecutiveIncorrect = 0;
  } else {
    session.lives -= 1;
    session.logicLabState!.consecutiveCorrect = 0;
    session.logicLabState!.consecutiveIncorrect += 1;
  }
}
```

### 5.3 Adaptive Difficulty Algorithm

**Triggers:**
- **Increase difficulty:** 2 consecutive correct answers
- **Decrease difficulty:** 2 consecutive incorrect answers
- **Range:** 1-5 (clamp to this range)

**Implementation:**
```typescript
private calculateNextDifficulty(session: GameSession): number {
  const state = session.logicLabState!;
  let nextLevel = state.currentDifficultyLevel;

  // Increase difficulty after 2 correct in a row
  if (state.consecutiveCorrect >= 2) {
    nextLevel = Math.min(5, nextLevel + 1);
    state.consecutiveCorrect = 0;  // Reset streak
  }

  // Decrease difficulty after 2 incorrect in a row
  if (state.consecutiveIncorrect >= 2) {
    nextLevel = Math.max(1, nextLevel - 1);
    state.consecutiveIncorrect = 0;  // Reset streak
  }

  return nextLevel;
}
```

**Initial Difficulty Mapping:**
```typescript
function mapDifficultyToLevel(difficulty: DifficultyLevel): number {
  return difficulty === 'easy' ? 2 : 3;  // Start at 2 (easy) or 3 (hard)
}
```

### 5.4 Problem Type Selection

**Strategy:** Random but balanced

```typescript
const PROBLEM_TYPES: ProblemType[] = ['riddle', 'pattern', 'category', 'cause-effect'];

function selectProblemType(previousTypes: ProblemType[]): ProblemType {
  // Avoid repeating the last type
  const lastType = previousTypes[previousTypes.length - 1];
  const availableTypes = PROBLEM_TYPES.filter(t => t !== lastType);

  // Random selection from available types
  return availableTypes[Math.floor(Math.random() * availableTypes.length)];
}
```

---

## 6. API Endpoints

### 6.1 POST /api/game/logic-lab/start

**Description:** Initialize a new Logic Lab game session

**Request:**
```typescript
{
  userId: string;              // User ID
  difficulty: DifficultyLevel; // 'easy' or 'hard'
  initialGuidance?: string;    // Optional adult input
}
```

**Response (200):**
```typescript
{
  sessionId: string;
  problem: {
    question: string;
    options: string[];         // 4 choices
  };
  score: 0;
  lives: 3;
  round: 1;
  totalRounds: 5;
}
```

**Error Response (400):**
```typescript
{ error: 'userId and difficulty are required' }
```

**Error Response (500):**
```typescript
{ error: 'Failed to start game' }
```

**Implementation:**
```typescript
// File: src/routes/api/game/logic-lab/start/+server.ts
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { LogicLabEngine } from '$lib/services/logic-lab.service';

export const POST: RequestHandler = async ({ request }) => {
  try {
    const { userId, difficulty, initialGuidance } = await request.json();

    if (!userId || !difficulty) {
      return json({ error: 'userId and difficulty required' }, { status: 400 });
    }

    const engine = new LogicLabEngine();
    const session = await engine.startGame({ userId, difficulty, initialGuidance });

    return json({
      sessionId: session._id?.toString(),
      problem: {
        question: session.logicLabState!.currentProblem.question,
        options: session.logicLabState!.currentProblem.options
      },
      score: session.score,
      lives: session.lives,
      round: session.round,
      totalRounds: session.logicLabState!.totalProblems
    });
  } catch (error) {
    console.error('Error starting Logic Lab game:', error);
    return json({ error: 'Failed to start game' }, { status: 500 });
  }
};
```

### 6.2 POST /api/game/logic-lab/answer

**Description:** Submit an answer and get next problem

**Request:**
```typescript
{
  sessionId: string;
  answerIndex: number;  // 0-3
}
```

**Response (200):**
```typescript
{
  correct: boolean;
  explanation: string;
  nextProblem?: {
    question: string;
    options: string[];
  };
  score: number;
  lives: number;
  round: number;
  gameOver: boolean;
  finalScore?: number;  // Only if gameOver = true
}
```

**Error Responses:**
```typescript
// 400
{ error: 'sessionId and answerIndex are required' }
{ error: 'Invalid answerIndex (must be 0-3)' }

// 404
{ error: 'Game session not found' }

// 500
{ error: 'Failed to submit answer' }
```

**Implementation:**
```typescript
// File: src/routes/api/game/logic-lab/answer/+server.ts
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { LogicLabEngine } from '$lib/services/logic-lab.service';

export const POST: RequestHandler = async ({ request }) => {
  try {
    const { sessionId, answerIndex } = await request.json();

    if (!sessionId || answerIndex === undefined) {
      return json({ error: 'sessionId and answerIndex required' }, { status: 400 });
    }

    if (answerIndex < 0 || answerIndex > 3) {
      return json({ error: 'Invalid answerIndex (must be 0-3)' }, { status: 400 });
    }

    const engine = new LogicLabEngine();
    const result = await engine.submitAnswer(sessionId, answerIndex);

    if (!result) {
      return json({ error: 'Game session not found' }, { status: 404 });
    }

    return json(result);
  } catch (error) {
    console.error('Error submitting answer:', error);
    return json({ error: 'Failed to submit answer' }, { status: 500 });
  }
};
```

### 6.3 GET /api/game/logic-lab/stats/:sessionId

**Description:** Get game statistics and history

**Response (200):**
```typescript
{
  sessionId: string;
  score: number;
  lives: number;
  totalProblems: number;
  correctAnswers: number;
  problemHistory: Array<{
    question: string;
    type: ProblemType;
    userAnswer: string;
    correctAnswer: string;
    isCorrect: boolean;
  }>;
  startedAt: string;
  endedAt?: string;
}
```

**Error Responses:**
```typescript
// 404
{ error: 'Game session not found' }

// 500
{ error: 'Failed to retrieve stats' }
```

---

## 7. UI Implementation

### 7.1 Component Structure

**File:** `src/routes/game/logic-lab/+page.svelte`

**Sections:**
1. **Initial Setup Screen** (shown once at start)
   - Text input for adult guidance
   - Start button

2. **Game Screen** (shown during gameplay)
   - Round counter (1/5, 2/5, etc.)
   - Score display
   - Lives display (❤️❤️❤️)
   - Problem question
   - 4 answer buttons

3. **Feedback Screen** (shown for 3 seconds after answer)
   - Correct/Incorrect indicator
   - Explanation text
   - Next button (auto-advances)

4. **Game Over Screen** (shown at end)
   - Final score
   - Performance summary
   - Play again button
   - View stats button

### 7.2 State Management (Svelte 5 Runes)

```typescript
<script lang="ts">
  import { onMount } from 'svelte';
  import { page } from '$app/stores';

  // Game state
  let gamePhase = $state<'setup' | 'playing' | 'feedback' | 'gameOver'>('setup');
  let sessionId = $state<string>('');

  // Setup phase
  let initialGuidance = $state<string>('');

  // Playing phase
  let currentProblem = $state<{ question: string; options: string[] } | null>(null);
  let score = $state<number>(0);
  let lives = $state<number>(3);
  let round = $state<number>(0);
  let totalRounds = $state<number>(5);

  // Feedback phase
  let lastAnswerCorrect = $state<boolean>(false);
  let explanation = $state<string>('');
  let selectedAnswerIndex = $state<number>(-1);

  // Loading states
  let loading = $state<boolean>(false);
  let submitting = $state<boolean>(false);

  // URL params
  const userId = $derived($page.url.searchParams.get('userId') || '');
  const difficulty = $derived($page.url.searchParams.get('difficulty') as 'easy' | 'hard' || 'easy');
</script>
```

### 7.3 Game Flow Logic

```typescript
async function startGame() {
  loading = true;

  try {
    const response = await fetch('/api/game/logic-lab/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId,
        difficulty,
        initialGuidance: initialGuidance.trim() || undefined
      })
    });

    if (!response.ok) throw new Error('Failed to start game');

    const data = await response.json();
    sessionId = data.sessionId;
    currentProblem = data.problem;
    score = data.score;
    lives = data.lives;
    round = data.round;
    totalRounds = data.totalRounds;
    gamePhase = 'playing';
  } catch (error) {
    console.error('Error starting game:', error);
    alert('Fehler beim Starten des Spiels');
  } finally {
    loading = false;
  }
}

async function submitAnswer(answerIndex: number) {
  if (submitting) return;

  submitting = true;
  selectedAnswerIndex = answerIndex;

  try {
    const response = await fetch('/api/game/logic-lab/answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, answerIndex })
    });

    if (!response.ok) throw new Error('Failed to submit answer');

    const data = await response.json();
    lastAnswerCorrect = data.correct;
    explanation = data.explanation;
    score = data.score;
    lives = data.lives;
    round = data.round;

    // Show feedback
    gamePhase = 'feedback';

    // Auto-advance after 3 seconds
    setTimeout(() => {
      if (data.gameOver) {
        gamePhase = 'gameOver';
      } else {
        currentProblem = data.nextProblem;
        selectedAnswerIndex = -1;
        gamePhase = 'playing';
      }
    }, 3000);

  } catch (error) {
    console.error('Error submitting answer:', error);
    alert('Fehler beim Senden der Antwort');
  } finally {
    submitting = false;
  }
}
```

### 7.4 UI Design (Tailwind v4)

**Colors:**
- Primary: Purple/pink gradient (matches existing games)
- Correct: Green (`bg-green-500`)
- Incorrect: Red (`bg-red-500`)
- Buttons: Large, colorful, kid-friendly

**Layout:**
- Centered content
- Large text (readable for kids)
- Big click targets (buttons min 80px height)
- Smooth transitions between phases

**Accessibility:**
- High contrast
- No reliance on color alone (use ✓/✗ icons)
- Keyboard navigation support

---

## 8. Environment Configuration

### 8.1 Environment Variables

**File:** `.env`
```bash
MONGODB_URI=mongodb://localhost:27017/humanbenchmark
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**File:** `src/env.d.ts`
```typescript
declare module '$env/static/private' {
  export const MONGODB_URI: string;
  export const OPENROUTER_API_KEY: string;
}
```

### 8.2 Getting an OpenRouter API Key

1. Go to https://openrouter.ai/
2. Sign up for free account
3. Navigate to Keys section
4. Create new key
5. Copy key (starts with `sk-or-v1-`)
6. Add to `.env` file

**Free tier:** $5 credit, enough for ~5000 games

---

## 9. Testing Strategy

### 9.1 Unit Tests

**Files to test:**
- `logic-lab.service.test.ts` - Game logic, scoring, difficulty adaptation
- `llm.service.test.ts` - Mock LLM responses, content validation

**Example test cases:**
```typescript
describe('LogicLabEngine', () => {
  test('should start game with initial difficulty', async () => {
    // Test game initialization
  });

  test('should increase difficulty after 2 correct answers', async () => {
    // Test adaptive difficulty
  });

  test('should decrease difficulty after 2 incorrect answers', async () => {
    // Test adaptive difficulty
  });

  test('should end game after 5 problems', async () => {
    // Test game completion
  });

  test('should end game when lives = 0', async () => {
    // Test game over condition
  });
});

describe('LLMService', () => {
  test('should validate safe content', () => {
    // Test content filtering
  });

  test('should use fallback problem if LLM fails', async () => {
    // Test error handling
  });
});
```

### 9.2 Integration Testing

**Manual testing checklist:**
- [ ] Start game with initial guidance
- [ ] Start game without initial guidance
- [ ] Answer correctly → see positive feedback
- [ ] Answer incorrectly → lose life, see explanation
- [ ] Get 2 correct in a row → harder problem
- [ ] Get 2 incorrect in a row → easier problem
- [ ] Complete all 5 problems → game over
- [ ] Lose all 3 lives → game over early
- [ ] View stats page after completion

### 9.3 LLM Testing

**Manual inspection:**
- Generate 20 problems across all difficulty levels
- Check for:
  - Appropriate vocabulary
  - Clear questions
  - 4 distinct options
  - Only one correct answer
  - Kid-friendly content
  - German grammar correctness

---

## 10. Error Handling & Edge Cases

### 10.1 LLM Failures

**Scenarios:**
- OpenRouter API is down
- API key is invalid
- Rate limit exceeded
- Response is malformed JSON
- Response fails content validation

**Handling:**
```typescript
async generateProblem(params: GenerateProblemParams): Promise<Problem> {
  try {
    const response = await this.callOpenRouter(params);
    const problem = this.parseResponse(response);

    if (!this.validateProblem(problem)) {
      throw new Error('Invalid problem generated');
    }

    return problem;
  } catch (error) {
    console.error('LLM generation failed:', error);
    return this.getFallbackProblem(params.difficultyLevel);
  }
}
```

### 10.2 Network Failures

**UI handling:**
- Show loading spinner during API calls
- Show error message if request fails
- Retry button for failed requests
- Don't lose game state on network error

### 10.3 Edge Cases

**Empty initial guidance:**
- Use default based on selected difficulty

**Multiple rapid clicks:**
- Disable buttons while submitting (`submitting` state)

**Browser refresh mid-game:**
- Game state is in MongoDB, could be resumed
- For MVP: treat as new session

**Invalid session ID:**
- Return 404 error
- Show "Game not found" message

---

## 11. Performance Considerations

### 11.1 Response Times

**Target:**
- Game start: < 3 seconds (includes LLM call)
- Answer submit: < 2 seconds (includes LLM call)
- Stats load: < 500ms (DB query only)

**Optimization:**
- Use fast LLM (Claude 3.5 Haiku)
- Keep prompts concise
- Cache fallback problems
- Index MongoDB queries

### 11.2 Cost Management

**Per game:**
- 5 LLM calls × ~$0.001 = ~$0.005

**Monitoring:**
- Log all API calls
- Track token usage
- Set up billing alerts on OpenRouter

### 11.3 Caching Strategy

**Not recommended for MVP:**
- Each problem should be unique/fresh
- Caching would reduce variety

**Future consideration:**
- Cache problems by difficulty/type
- Pre-generate problem pool
- Hybrid: cache + dynamic generation

---

## 12. Future Enhancements

### 12.1 Phase 2 Features

1. **Hint System**
   - Kid can request a hint (costs 0 points but no life lost)
   - LLM generates contextual hint

2. **Image Support**
   - Use vision models for visual problems
   - "Which shape is different?"

3. **Voice Input**
   - Kids speak answers instead of clicking
   - Speech-to-text via browser API

4. **Parent Dashboard**
   - Review conversation history
   - See problem types child struggles with
   - Export progress report

5. **Multiplayer Mode**
   - Two kids compete on same device
   - Take turns answering

### 12.2 Technical Improvements

1. **Problem Pool Pre-generation**
   - Generate 100 problems on server startup
   - Serve from pool, regenerate in background

2. **Multi-model Support**
   - Try multiple models if one fails
   - A/B test different models for quality

3. **Advanced Adaptation**
   - Track problem types child excels at
   - Personalize problem type distribution
   - Machine learning for optimal difficulty curve

4. **Internationalization**
   - English, French, Spanish versions
   - Language-specific word pools

---

## 13. Implementation Checklist

### 13.1 Files to Create

- [ ] `docs/LOGIC-LAB-SPEC.md` (this file)
- [ ] `src/lib/services/llm.service.ts`
- [ ] `src/lib/services/logic-lab.service.ts`
- [ ] `src/routes/api/game/logic-lab/start/+server.ts`
- [ ] `src/routes/api/game/logic-lab/answer/+server.ts`
- [ ] `src/routes/api/game/logic-lab/stats/+server.ts`
- [ ] `src/routes/game/logic-lab/+page.svelte`
- [ ] `src/lib/services/llm.service.test.ts` (optional)
- [ ] `src/lib/services/logic-lab.service.test.ts` (optional)

### 13.2 Files to Modify

- [ ] `src/lib/types/index.ts` - Add LogicLabGameState, Problem, etc.
- [ ] `src/env.d.ts` - Add OPENROUTER_API_KEY type
- [ ] `.env` - Add OPENROUTER_API_KEY value
- [ ] `src/routes/+page.svelte` - Add Logic Lab game card
- [ ] `README.md` - Document new game (optional)

### 13.3 Testing Checklist

- [ ] Unit tests pass (if written)
- [ ] Can start game with initial guidance
- [ ] Can start game without initial guidance
- [ ] Problems are age-appropriate and in German
- [ ] Correct answers increase score
- [ ] Incorrect answers decrease lives
- [ ] Difficulty adapts after streaks
- [ ] Game ends after 5 problems
- [ ] Game ends when lives = 0
- [ ] Stats page shows correct data
- [ ] No banned words in generated content
- [ ] Fallback problems work if LLM fails

---

## 14. Deployment Notes

### 14.1 Environment Setup

**Development:**
```bash
# .env
MONGODB_URI=mongodb://localhost:27017/humanbenchmark
OPENROUTER_API_KEY=sk-or-v1-...
```

**Production:**
- Set environment variables in hosting platform
- Use MongoDB Atlas or similar for remote DB
- Monitor OpenRouter usage/costs

### 14.2 Security

**API Key Protection:**
- Never expose `OPENROUTER_API_KEY` to client
- All LLM calls MUST be server-side
- Use SvelteKit's `$env/static/private` (not `$env/static/public`)

**Content Safety:**
- Log all generated problems
- Manual review first 100 games
- Set up alerts for content violations

### 14.3 Monitoring

**Metrics to track:**
- LLM API success rate
- Average response time
- Content safety violations
- User completion rate
- Average score per difficulty

---

## 15. References

### 15.1 External Documentation

- **OpenRouter:** https://openrouter.ai/docs
- **Svelte 5:** https://svelte.dev/docs/svelte/overview
- **SvelteKit:** https://kit.svelte.dev/docs
- **Tailwind CSS v4:** https://tailwindcss.com/docs

### 15.2 Project Documentation

- `CLAUDE.md` - Main project guide
- `ARCHITECTURE.md` - System architecture
- `TECH-STACK.md` - Technology details
- `API-REFERENCE.md` - Existing API docs

---

**END OF SPECIFICATION**

This spec should be comprehensive enough to implement the entire Logic Lab game. Let me know if you need any clarifications before starting implementation!
